<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <style type="text/css">
        input{
            width: 92.5vw;
            height: 2.85vh;
            border: none;
        }
        input::placeholder{
            font-family: AppleSDGothicNeo;
            font-size: 2.1vh;
            font-weight: normal;
            font-style: normal;
            font-stretch: normal;
            line-height: 1.14;
            letter-spacing: normal;
            color: #e4e4e4;
        }
    </style>
    <title>userInfo</title>
    <script>
        //이메일 받아오기
        var userID = sessionStorage.getItem("id");
        var userPassword = sessionStorage.getItem("session_pw");
        //비밀번호 확인하기
        var checkpw = function(){
            if(document.getElementById("inputPW_userInfo").value==document.getElementById("inputCheckPW_userInfo").value){
                document.getElementById("alert_pwC_form").style.color="#5f9ea0";
                document.getElementById("alert_pwC_form").innerHTML="비밀번호가 일치합니다.";
            }else{
                document.getElementById("alert_pwC_form").style.color="red";
                document.getElementById("alert_pwC_form").innerHTML="비밀번호가 일치하지 않습니다.";
            }
        }


        var checkemail = function() {
            var filter = /^([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
            if(filter.test($("#inputEmail_userInfo").val())){
                document.getElementById("alert_email_form").style.color="#5f9ea0";
                document.getElementById("alert_email_form").innerHTML="이메일 형식이 올바릅니다.";
            }else{
                document.getElementById("alert_email_form").style.color="red";
                document.getElementById("alert_email_form").innerHTML="이메일 형식이 올바르지 않습니다."
            }
        }

        var checkphonenum = function() {
            var regPhone = /^((01[1|6|7|8|9])[1-9]+[0-9]{6,7})|(010[1-9][0-9]{7})$/;
            if(regPhone.test($("#inputPhoneNum_userInfo").val())){
                document.getElementById("alert_num_form").style.color="#5f9ea0";
                document.getElementById("alert_num_form").innerHTML="핸드폰 번호 형식이 올바릅니다.";
            }else{
                document.getElementById("alert_num_form").style.color="red";
                document.getElementById("alert_num_form").innerHTML="핸드폰 번호 형식이 올바르지 않습니다."
            }
        }
    </script>
</head>
<body>
<div class="wrapper">
    <div class = "header">
        <a href="javascript:history.back();">
            <img src="img/ic-back@2x.png" layout="responsive"
            class="ic_back">
        </a>
        <span class="header_title">회원 정보 수정</span>
    </div>
    
    <div class="content">
        <form>
            <!-- 서버에서 불러온 id -->
            <div class="rec_form">
                <label class="title_form">ID</label>
                <div class="box_form">
                    <script>
                        document.write(userID);
                    </script>
                </div>
            </div>
            <!-- 비밀번호 -->
            <div class="rec_form">
                <label for="inputPW_userInfo" class="title_form">비밀번호</label>
                <div class="box_form">
                    <input id="inputPW_userInfo" type="password" name="password" placeholder="비밀번호를 입력하세요." onkeyup="checkpw();" required>
                </div>
                <div class="line_form" id="line_pw_form"></div>
                <div class="alert_form" id="alert_pw_form"></div>
            </div>
            <!-- 비밀번호 확인 -->
            <div class="rec_form">
                <label for="inputCheckPW_userInfo" class="title_form">비밀번호 확인</label>
                <div class="box_form">
                    <input id="inputCheckPW_userInfo" type="password" name="passwordCheck" placeholder="비밀번호를 다시 입력해주세요." onkeyup="checkpw();" required>
                </div>
                <div class="line_form" id="line_pwC_form"></div>
                <div class="alert_form" id="alert_pwC_form" style="color:red;"></div>
            </div>
            <!-- 핸드폰 번호 -->
            <div class="rec_form">
                <label for="inputPhoneNum_userInfo" class="title_form">핸드폰 번호</label>
                <div class="box_form">
                    <input id="inputPhoneNum_userInfo" type="number" name="phoneNum" placeholder="핸드폰 번호를 입력해주세요." onkeyup="checkphonenum();" required>
                </div>
                <div class="line_form" id="line_num_form"></div>
                <div class="alert_form" id="alert_num_form"></div>
            </div>
            <!-- 이메일 주소 -->
            <div class="rec_form">
                    <label for="inputEmail_userInfo" class="title_form">이메일 주소</label>
                    <div class="box_form">
                        <input id="inputEmail_userInfo" type="email" name="email" placeholder="이메일 주소를 입력해주세요." onkeyup="checkemail();" required>
                    </div>
                    <div class="line_form" id="line_email_form"></div>
                    <div class="alert_form" id="alert_email_form"></div>
                </div>
        </form>
        <div class="rec1_userInfo"></div>
        <div class="rec2_btn_userInfo">
            <div class="btn_form">
                <span class="btn_text_form">수정</span>
            </div>
        </div>
        <a href="02_mypage.html"><div class="rec3_btn_userInfo"></div></a>
    </div>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<!--session에 있는 비밀번호 띄워주기-->
<script type="text/javascript">	
    $(document).ready(function(){
        $("#inputPW_userInfo").val(userPassword);
    });
</script>
<!--현재 로그인 되어 있는 user의 비밀번호와 핸드폰 번호 받아오기 -->
<script>
    $(function(){
        var userID2 = "id=" + sessionStorage.getItem("id"); 
        $.ajax({
            type : "POST",
            url : "http://13.125.138.168:8080/gungduk/api/v1/modifyInfo",
            data : userID2,
            async: false,
            success: function(data){
                $("#inputPhoneNum_userInfo").val(data[0].phoneNum);
                $("#inputEmail_userInfo").val(data[0].email);
            },
            error:function(request, error){
                // con
                alert("message: "+request.responseText);
            }
        });
    });
</script>
<script>
    function checkEmail(input_email){
        var filter = /^([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
        return filter.test(input_email);
    }
    function checkPhoneNum(p) {
            p = p.split('-').join('');
            var regPhone = /^((01[1|6|7|8|9])[1-9]+[0-9]{6,7})|(010[1-9][0-9]{7})$/;
            return regPhone.test(p);
        }
</script>
<!--변경된 정보(ID 제외)를 서버에 전달-->
<script>
    $(function(){
        $(".rec2_btn_userInfo").click(function(){
            var exptext = /[0-9a-zA-Z][_0-9a-zA-Z-]*@[_0-9a-zA-Z-]+(\.[_0-9a-zA-Z-]+){1,2}$/;

            var userID3 = sessionStorage.getItem("id");
            var newPW = $("#inputPW_userInfo").val();
            var newPWCheck = $("#inputCheckPW_userInfo").val();
            var newEmail = $("#inputEmail_userInfo").val();
            var newPhoneNum = $("#inputPhoneNum_userInfo").val();

            if( $("#inputPW_userInfo").val() == "" || $("#inputCheckPW_userInfo").val() == "" || $("#inputEmail_userInfo").val() == "" || $("#inputPhoneNum_userInfo").val() == "" ){
                if ( $("#inputPW_userInfo").val() == "" ){
                    $("#alert_pw_form").text('비밀번호를 입력하세요.');
                    if($("#inputPW_userInfo").keydown(function(){
                        $('#alert_pw_form').empty();
                    }));
                } 
                if ( $("#inputCheckPW_userInfo").val() == "" ){
                    $("#alert_pwC_form").text('비밀번호 확인을 입력하세요.');
                    if($("#inputCheckPW_userInfo").keyup(function(){
                        $('#alert_pwC_form').empty();
                    }));
                } 
                if ( $("#inputEmail_userInfo").val() == "" ){
                    $("#alert_email_form").text('이메일 주소를 입력하세요.');
                    if($("#inputEmail_userInfo").keydown(function(){
                        $('#alert_email_form').empty();
                    }));
                }
                if ( $("#inputPhoneNum_userInfo").val() == "" ){
                    $("#alert_num_form").text('핸드폰 번호를 입력하세요.');
                    if($("#inputPhoneNum_userInfo").keydown(function(){
                        $('#alert_num_form').empty();
                    }));
                }
            }
            if ( $("#inputPW_userInfo").val() != $("#inputCheckPW_userInfo").val() || !checkEmail(newEmail) || !checkPhoneNum(newPhoneNum) ){
                $(".rec1_userInfo").css('color','red');
                $(".rec1_userInfo").text('기입된 정보가 올바르지 않습니다.');
                return false;
            }
            if ( $("#inputPW_userInfo").val() != $("#inputCheckPW_userInfo").val() ){
                $(".rec1_userInfo").css('color','red');
                $(".rec1_userInfo").text('비밀번호가 일치하지 않습니다.');
                return false;
            }
            
            if (!checkEmail(newEmail)) {
                $(".rec1_userInfo").css('color','red');
                $(".rec1_userInfo").text('이메일 형식이 올바르지 않습니다.');
                return false;
            }
            if (!checkPhoneNum(newPhoneNum)) {
            $(".rec1_userInfo").css('color','red');
                $(".rec1_userInfo").text('핸드폰 번호를 다시 입력해주세요.');
                return false;
            }

            $.ajax({
                type : "POST",
                url : "http://13.125.138.168:8080/gungduk/api/v1/updateInfo",
                data : {"id": userID3, 
                        "pw": newPW, 
                        "email":newEmail, 
                        "phoneNum": newPhoneNum},
                async : false,
                success : function(data){ 
                    $(".rec1_userInfo").css('color','#36797b');
                    $(".rec1_userInfo").text('회원 정보가 수정되었습니다.');
                    $(".rec2_btn_userInfo").remove();
                    $(".rec3_btn_userInfo").css({
                        'width': '92.5vw',
                        'height': '7.85vh',
                        'border-radius': '8px',
                        'background-color': '#5f9ea0',
                        'margin-left': '3.75vw',
                        'text-align': 'center',
                        'margin-top': '1.78vh',
                        'margin-bottom': '2.14vh',
                        'position': 'absolute',
                        'bottom': '0'
                    })
                    $(".rec3_btn_userInfo").append("<span style='height: 7.85vh;font-size: 0.875em;font-weight: bold;font-style: normal;font-stretch: normal;letter-spacing: -0.5px;color: #ffffff;line-height: 7.85vh;'>마이페이지로 이동</span>");
                },
                error :function(request, error){
                    console.log(error.responseText);
                        console.log(request.responseText);
                }
            });
        });
    });
</script>
</body>
</html>